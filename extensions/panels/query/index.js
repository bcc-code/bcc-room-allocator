import{useApi as e}from"@directus/extensions-sdk";import{resolveComponent as t,openBlock as n,createElementBlock as i,normalizeClass as r,createBlock as a,withCtx as o,createTextVNode as s,toDisplayString as l,Fragment as d,createVNode as c,createCommentVNode as h}from"vue";var u={props:{id:String,showHeader:{type:Boolean,default:!1},columnWidth:{type:String,default:""},download:{type:Boolean,default:!0}},data:()=>({loading:!0,error:"",headers:null,items:null}),created(){this.fetchData()},methods:{async fetchData(){const t=e();this.loading=!0,this.error="",this.headers=null,this.items=null;try{const{data:{headers:e,items:n,error:i}}=await t(`insights/query/${this.id}`);if(i&&(this.error=i),e&&n){const t=n.length>2;let i=this.columnWidth.split(",").map(parseFloat);e.forEach((function(e,n){e.width=i[n],e.sortable=t})),this.headers=e,this.items=n}}catch(e){this.error=e.response?.data?.error||e.message}this.loading=!1},itemsToCsv(){let e="";return this.items.forEach((t=>{for(let n in t)/[, ]/.test(t[n])?e+=`"${t[n].replace(/"/g,'\\"')}",`:e+=t[n]+",";e+="\r\n"})),e},exportCSVFile(){if(this.headers&&this.items){let e=Object.values(this.headers).map((e=>e.text)).join(",");e+="\r\n",e+=this.itemsToCsv();const t=(new Date).toISOString()+".csv"||"export.csv",n=new Blob([e],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(n,t);else{const e=document.createElement("a");if(void 0!==e.download){const i=URL.createObjectURL(n);e.setAttribute("href",i),e.setAttribute("download",t),e.style.visibility="hidden",document.body.appendChild(e),e.click(),document.body.removeChild(e)}}}}}};const p={key:0,class:"center"};var m=[],f=[];!function(e,t){if(e&&"undefined"!=typeof document){var n,i=!0===t.prepend?"prepend":"append",r=!0===t.singleTag,a="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(r){var o=m.indexOf(a);-1===o&&(o=m.push(a)-1,f[o]={}),n=f[o]&&f[o][i]?f[o][i]:f[o][i]=s()}else n=s();65279===e.charCodeAt(0)&&(e=e.substring(1)),n.styleSheet?n.styleSheet.cssText+=e:n.appendChild(document.createTextNode(e))}function s(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var n=Object.keys(t.attributes),r=0;r<n.length;r++)e.setAttribute(n[r],t.attributes[n[r]]);var o="prepend"===i?"afterbegin":"beforeend";return a.insertAdjacentElement(o,e),e}}("\n.sql-panel-container {\n  width: 100%;\n  height: 100%;\n  --v-table-height: 100%;\n}\n.sql-panel-container .v-text-overflow {\n  user-select: text;\n  white-space: pre-wrap;\n}\n.sql-panel-container .center {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  width: 100%;\n  height: 100%;\n}\n.export-csv-button {\n  position: absolute;\n  right: 0;\n  bottom: 0;\n  z-index: 2;\n  opacity: 0.8\n}\n.export-csv-button .button {\n  border-radius: var(--border-radius) 0 0 0 !important;\n}\n",{}),u.render=function(e,u,m,f,v,b){const y=t("v-progress-circular"),g=t("v-notice"),w=t("v-icon"),x=t("v-button"),S=t("v-table");return n(),i("div",{class:r(["sql-panel-container",{"has-header":m.showHeader}])},[v.loading||v.error?(n(),i("div",p,[v.loading?(n(),a(y,{key:0,indeterminate:""})):(n(),a(g,{key:1,type:"danger",center:""},{default:o((()=>[s(l(v.error),1)])),_:1}))])):v.headers&&v.items?(n(),i(d,{key:1},[m.download?(n(),a(x,{key:0,onClick:b.exportCSVFile,icon:"",secondary:"",class:"export-csv-button"},{default:o((()=>[c(w,{name:"download-file"})])),_:1},8,["onClick"])):h("v-if",!0),c(S,{showResize:!0,headers:v.headers,items:v.items,"fixed-header":""},null,8,["headers","items"])],64)):h("v-if",!0)],2)},u.__file="src/panel.vue";var v={id:"query-panel",name:"Query panel",icon:"box",description:"Show result of a stored SQL query as a table",component:u,options:[{field:"sql",name:"SQL query",type:"string",meta:{interface:"input-code",width:"full",options:{language:"sql"}}},{field:"columnWidth",name:"Column widths (, separated)",type:"string",meta:{interface:"input",width:"half"}},{field:"download",name:"Download button",type:"boolean",meta:{width:"half",interface:"boolean",options:{label:"Show"}},schema:{default_value:!0}}],minWidth:12,minHeight:8};export{v as default};
